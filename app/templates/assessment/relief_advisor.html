{% extends "base.html" %}
{% block title %}Transitional Relief Advisor - {{ assessment.title }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2><i class="bi bi-clock-history me-2"></i>Transitional Relief Advisor</h2>
        <p class="text-muted mb-0">{{ assessment.title }} | {{ assessment.entity_name }} | {{ assessment.fiscal_year }}</p>
    </div>
    <div class="no-print">
        <button onclick="window.print()" class="btn btn-danger me-2">
            <i class="bi bi-file-earmark-pdf me-1"></i>Export PDF
        </button>
        <a href="{{ url_for('assessment.view', assessment_id=assessment.id) }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-1"></i>Back
        </a>
    </div>
</div>

<!-- Summary Dashboard -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card stat-card {% if summary.is_first_year %}stat-green{% else %}stat-red{% endif %}">
            <div class="card-body text-center">
                <i class="bi bi-calendar-check stat-icon"></i>
                <div class="stat-value" style="font-size: 1.3rem;">
                    {% if summary.is_first_year %}
                    Year 1
                    {% else %}
                    Year 2+
                    {% endif %}
                </div>
                <div class="stat-label">Reporting Period</div>
                <small style="color: var(--text-muted);">FY ends {{ summary.first_fy_end }}</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card {% if summary.months_to_deadline <= 6 %}stat-red{% elif summary.months_to_deadline <= 12 %}stat-yellow{% else %}stat-blue{% endif %}">
            <div class="card-body text-center">
                <i class="bi bi-hourglass-split stat-icon"></i>
                <div class="stat-value" style="font-size: 1.3rem;">{{ summary.months_to_deadline }}</div>
                <div class="stat-label">Months to FY End</div>
                {% if summary.months_to_deadline <= 6 %}
                <span class="badge bg-danger">Critical</span>
                {% elif summary.months_to_deadline <= 12 %}
                <span class="badge bg-warning text-dark">Tight</span>
                {% else %}
                <span class="badge bg-info">Adequate</span>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card stat-green">
            <div class="card-body text-center">
                <i class="bi bi-shield-check stat-icon"></i>
                <div class="stat-value" style="font-size: 1.3rem;">{{ summary.total_relief_available }}</div>
                <div class="stat-label">Reliefs Available</div>
                <small style="color: var(--text-muted);">{{ summary.total_deferred }} deferral, {{ summary.total_simplified }} simplified</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card stat-red">
            <div class="card-body text-center">
                <i class="bi bi-exclamation-triangle stat-icon"></i>
                <div class="stat-value" style="font-size: 1.3rem;">{{ summary.critical_now }}</div>
                <div class="stat-label">Fix Now (LA Gaps)</div>
                <small style="color: var(--text-muted);">In LA scope, below threshold</small>
            </div>
        </div>
    </div>
</div>

{% if not summary.is_first_year %}
<div class="alert alert-warning mb-4">
    <i class="bi bi-exclamation-triangle me-2"></i>
    <strong>Year 2+ Reporting:</strong> Most transitional reliefs have expired. All criteria below now require full compliance.
    The items below show what was available in Year 1 and what is now required.
</div>
{% endif %}

<!-- Critical Items: Cannot Defer -->
{% set critical_items = relief_items | selectattr('urgency', 'equalto', 'critical') | list %}
{% if critical_items %}
<div class="card mb-4" style="border: 1px solid rgba(239,68,68,0.4);">
    <div class="card-header" style="background: var(--gradient-red);">
        <i class="bi bi-exclamation-octagon me-2 text-white"></i>
        <span class="text-white fw-bold">Cannot Defer: Fix These Now ({{ critical_items|length }})</span>
    </div>
    <div class="card-body">
        <p class="text-danger small mb-3">These criteria are in limited assurance scope and scored below 3. Relief may simplify the approach, but you must still address them before the auditor examines your disclosures.</p>
        {% for item in critical_items %}
        <div class="card mb-3 border-danger">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <div>
                        <code class="fs-6">{{ item.criterion_id }}</code> — <strong>{{ item.category }}</strong>
                        <span class="badge bg-danger ms-2">Score: {{ item.score if item.score is not none else '—' }}</span>
                        <span class="badge bg-danger bg-opacity-75"><i class="bi bi-shield-check me-1"></i>LA In Scope</span>
                    </div>
                </div>
                {% if item.applicable %}
                <div class="row">
                    <div class="col-md-6">
                        <div class="p-3 rounded" style="background: rgba(239,68,68,0.08); border: 1px solid rgba(239,68,68,0.2);">
                            <h6 class="text-danger mb-2"><i class="bi bi-exclamation-circle me-1"></i>Must Do Now</h6>
                            <small>{{ item.what_you_must_do }}</small>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="p-3 rounded" style="background: rgba(34,197,94,0.08); border: 1px solid rgba(34,197,94,0.2);">
                            <h6 class="text-success mb-2"><i class="bi bi-clock-history me-1"></i>Can Simplify (Year 1)</h6>
                            <small>{{ item.what_you_can_defer }}</small>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="alert alert-warning py-2 mb-0">
                    <small><i class="bi bi-exclamation-triangle me-1"></i><strong>Year 2+:</strong> {{ item.year2_requirement }}</small>
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Available Reliefs -->
{% set available_items = [] %}
{% for item in relief_items %}
    {% if item.applicable and item.urgency != 'critical' %}
        {% if available_items.append(item) %}{% endif %}
    {% endif %}
{% endfor %}

{% if available_items %}
<div class="card mb-4">
    <div class="card-header" style="background: var(--gradient-green);">
        <i class="bi bi-check-circle me-2 text-white"></i>
        <span class="text-white fw-bold">Available Transitional Reliefs ({{ available_items|length }})</span>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th style="width: 80px;">ID</th>
                        <th>Category</th>
                        <th style="width: 60px;">Score</th>
                        <th>What You Can Defer/Simplify</th>
                        <th>What You Must Still Do</th>
                        <th>Year 2 Requirement</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in available_items %}
                    <tr>
                        <td>
                            <code>{{ item.criterion_id }}</code>
                            {% if item.is_deferral %}
                            <br><span class="badge bg-success" style="font-size: 0.6em;">FULL DEFERRAL</span>
                            {% else %}
                            <br><span class="badge bg-info" style="font-size: 0.6em;">SIMPLIFY</span>
                            {% endif %}
                        </td>
                        <td>
                            <small>{{ item.category }}</small>
                            <br>
                            {% set ob = obligation_labels.get(item.obligation, {}) %}
                            <span class="badge bg-{{ ob.get('badge', 'secondary') }}" style="font-size: 0.6em;">{{ ob.get('label', item.obligation) }}</span>
                        </td>
                        <td>
                            {% if item.score is not none %}
                            <span class="score-badge score-{{ item.score }}">{{ item.score }}</span>
                            {% else %}
                            <span class="score-badge score-0">—</span>
                            {% endif %}
                        </td>
                        <td>
                            <small class="text-success"><i class="bi bi-check-circle me-1"></i>{{ item.what_you_can_defer }}</small>
                        </td>
                        <td>
                            <small class="text-warning"><i class="bi bi-exclamation-circle me-1"></i>{{ item.what_you_must_do }}</small>
                        </td>
                        <td>
                            <small class="text-muted"><i class="bi bi-arrow-right me-1"></i>{{ item.year2_requirement }}</small>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

<!-- Japan-Specific Alternatives -->
{% if japan_items %}
<div class="card mb-4">
    <div class="card-header" style="background: var(--gradient-blue);">
        <i class="bi bi-flag me-2 text-white"></i>
        <span class="text-white fw-bold">Japan-Specific Shortcuts ({{ japan_items|length }})</span>
    </div>
    <div class="card-body">
        <p class="text-muted small mb-3">These are SSBJ-specific alternatives or shortcuts not available under vanilla ISSB. They are always applicable regardless of reporting year.</p>
        {% for item in japan_items %}
        <div class="card mb-3">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <div>
                        <code>{{ item.criterion_id }}</code> — <strong>{{ item.category }}</strong>
                        {% if item.score is not none %}
                        <span class="score-badge score-{{ item.score }} ms-2">{{ item.score }}</span>
                        {% endif %}
                    </div>
                    <span class="badge bg-primary bg-opacity-75"><i class="bi bi-flag-fill me-1"></i>Japan SSBJ</span>
                </div>
                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="p-2 rounded h-100" style="background: rgba(59,130,246,0.08);">
                            <small class="fw-bold d-block mb-1"><i class="bi bi-lightning me-1"></i>Alternative</small>
                            <small>{{ item.alternative }}</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="p-2 rounded h-100" style="background: rgba(34,197,94,0.08);">
                            <small class="fw-bold d-block mb-1"><i class="bi bi-check2 me-1"></i>Action</small>
                            <small>{{ item.action }}</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="p-2 rounded h-100" style="background: rgba(249,115,22,0.08);">
                            <small class="fw-bold d-block mb-1"><i class="bi bi-star me-1"></i>Benefit</small>
                            <small>{{ item.benefit }}</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- No Transitional Relief: Disclosure Required from Year 1 -->
{% if no_relief_items %}
<div class="card mb-4" style="border: 1px solid rgba(239,68,68,0.3);">
    <div class="card-header">
        <i class="bi bi-x-octagon me-2 text-danger"></i>
        <strong>No Transitional Relief — Disclosure Required from Year 1 ({{ no_relief_items|length }})</strong>
    </div>
    <div class="card-body">
        <p class="text-muted small mb-2">These Governance and Risk Management criteria must be <strong>disclosed from Year 1</strong>. However, <strong>assurance examination begins one year later (Year 2)</strong>, giving companies a grace period to mature their processes before auditor scrutiny.</p>
        <div class="alert alert-info py-2 mb-3">
            <small><i class="bi bi-info-circle me-1"></i><strong>Climate-only Year 1:</strong> Under the SSBJ transition provision, these items are required only to the extent they relate to <strong>climate-related</strong> risks and opportunities — not all sustainability topics. Full sustainability scope applies from Year 2.</small>
        </div>
        <div class="table-responsive">
            <table class="table table-sm mb-0">
                <thead><tr><th>ID</th><th>Category</th><th>Score</th><th>Status</th><th>Disclosure Requirement</th><th>Climate-Only Scope</th></tr></thead>
                <tbody>
                    {% for item in no_relief_items %}
                    <tr {% if item.at_risk %}style="background: rgba(239,68,68,0.06);"{% endif %}>
                        <td><code>{{ item.criterion_id }}</code></td>
                        <td><small>{{ item.category }}</small></td>
                        <td>{% if item.score is not none %}<span class="score-badge score-{{ item.score }}">{{ item.score }}</span>{% else %}<span class="text-muted">—</span>{% endif %}</td>
                        <td>{% if item.at_risk %}<span class="badge bg-danger">At Risk</span>{% else %}<span class="badge bg-success">OK</span>{% endif %}</td>
                        <td><small class="text-muted">{{ item.reason }}</small></td>
                        <td><small class="text-info">{{ item.climate_only_note }}</small></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <p class="text-muted small mt-2 mb-0"><i class="bi bi-clock me-1"></i>Assurance grace period: While disclosure is mandatory from Year 1, assurance providers will first examine these items in Year 2. Use Year 1 to establish, test, and document your processes.</p>
    </div>
</div>
{% endif %}

<!-- RSK-05: Internal Controls (Not a Standalone Disclosure Item) -->
{% if rsk05_item %}
<div class="card mb-4" style="border: 1px solid rgba(249,115,22,0.4);">
    <div class="card-header">
        <i class="bi bi-gear me-2" style="color: #f97316;"></i>
        <strong>RSK-05: Internal Controls — Implicit Requirement</strong>
        {% if rsk05_item.score is not none %}
        <span class="score-badge score-{{ rsk05_item.score }} ms-2">{{ rsk05_item.score }}</span>
        {% endif %}
        {% if rsk05_item.at_risk %}<span class="badge bg-warning text-dark ms-1">Attention Needed</span>{% endif %}
    </div>
    <div class="card-body">
        <p class="small mb-2"><strong>{{ rsk05_item.reason }}</strong></p>
        <p class="small text-muted mb-2">{{ rsk05_item.note }}</p>
        <div class="alert alert-warning py-2 mb-0">
            <small><i class="bi bi-clock me-1"></i>{{ rsk05_item.assurance_note }}</small>
        </div>
    </div>
</div>
{% endif %}

<!-- Climate-Only Year 1 Option -->
{% if climate_only_option and climate_only_option.available %}
<div class="card mb-4" style="border: 1px solid rgba(59,130,246,0.4);">
    <div class="card-header" style="background: var(--gradient-blue);">
        <i class="bi bi-cloud-sun me-2 text-white"></i>
        <span class="text-white fw-bold">Climate-Only Year 1 Option (SSBJ No.2 Focus)</span>
    </div>
    <div class="card-body">
        <p class="small mb-3">{{ climate_only_option.note }}</p>
        <div class="row mb-3">
            <div class="col-md-3">
                <div class="card"><div class="card-body text-center py-2">
                    <div class="fw-bold" style="font-size: 1.1rem;">{{ climate_only_option.s2_total }}</div>
                    <small class="text-muted">Climate (S2) Criteria</small>
                    {% if climate_only_option.s2_gaps %}<br><small class="text-danger">{{ climate_only_option.s2_gaps }} gaps</small>{% endif %}
                </div></div>
            </div>
            <div class="col-md-3">
                <div class="card"><div class="card-body text-center py-2">
                    <div class="fw-bold" style="font-size: 1.1rem;">{{ climate_only_option.s1_total }}</div>
                    <small class="text-muted">General (S1) Criteria</small>
                    {% if climate_only_option.s1_gaps %}<br><small class="text-danger">{{ climate_only_option.s1_gaps }} gaps</small>{% endif %}
                </div></div>
            </div>
            <div class="col-md-3">
                <div class="card" style="border-color: rgba(34,197,94,0.5);"><div class="card-body text-center py-2">
                    <div class="fw-bold text-success" style="font-size: 1.1rem;">{{ climate_only_option.s1_deferrable_count }}</div>
                    <small class="text-muted">S1 Items Deferrable</small>
                </div></div>
            </div>
            <div class="col-md-3">
                <div class="card" style="border-color: rgba(239,68,68,0.5);"><div class="card-body text-center py-2">
                    <div class="fw-bold text-danger" style="font-size: 1.1rem;">{{ climate_only_option.s1_la_scope_count }}</div>
                    <small class="text-muted">S1 Items NOT Deferrable</small>
                    <br><small class="text-muted">(in LA scope)</small>
                </div></div>
            </div>
        </div>

        {% if climate_only_option.s1_deferrable %}
        <h6 class="small fw-bold mb-2"><i class="bi bi-check-circle text-success me-1"></i>General (S1) criteria you CAN defer to Year 2:</h6>
        <div class="d-flex flex-wrap gap-1 mb-3">
            {% for item in climate_only_option.s1_deferrable %}
            <span class="badge bg-success bg-opacity-75"><code class="text-white">{{ item.id }}</code> {{ item.category }}</span>
            {% endfor %}
        </div>
        {% endif %}

        {% if climate_only_option.s1_la_scope %}
        <h6 class="small fw-bold mb-2"><i class="bi bi-x-circle text-danger me-1"></i>General (S1) criteria you CANNOT defer (in LA scope):</h6>
        <div class="d-flex flex-wrap gap-1 mb-2">
            {% for item in climate_only_option.s1_la_scope %}
            <span class="badge bg-danger bg-opacity-75"><code class="text-white">{{ item.id }}</code> {{ item.category }}</span>
            {% endfor %}
        </div>
        <small class="text-muted"><i class="bi bi-info-circle me-1"></i>Even in "climate-only" mode, Governance and Risk Management criteria remain mandatory because they are in the initial limited assurance scope.</small>
        {% endif %}
    </div>
</div>
{% endif %}

<!-- Year 1 vs Year 2 Comparison -->
<div class="card mb-4">
    <div class="card-header"><i class="bi bi-arrow-left-right me-2"></i>Year 1 vs Year 2+ Requirements</div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-sm mb-0">
                <thead>
                    <tr>
                        <th>Area</th>
                        <th>Year 1 (Transitional)</th>
                        <th>Year 2+ (Full Compliance)</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Scope 1 GHG</strong></td>
                        <td><small>Simplified methodology acceptable</small></td>
                        <td><small>Full GHG Protocol alignment required</small></td>
                    </tr>
                    <tr>
                        <td><strong>Scope 2 GHG</strong></td>
                        <td><small>Location-based only sufficient</small></td>
                        <td><small>Both location-based and market-based required</small></td>
                    </tr>
                    <tr>
                        <td><strong>Scope 3 GHG</strong></td>
                        <td><small class="text-success fw-bold">Can defer entirely</small></td>
                        <td><small>All 15 categories required (estimates OK)</small></td>
                    </tr>
                    <tr>
                        <td><strong>Scenario Analysis</strong></td>
                        <td><small>Qualitative narrative acceptable</small></td>
                        <td><small>Quantitative analysis expected</small></td>
                    </tr>
                    <tr>
                        <td><strong>Value Chain</strong></td>
                        <td><small>Proportionality relief on data collection</small></td>
                        <td><small>Progressive expansion of value chain coverage</small></td>
                    </tr>
                    <tr>
                        <td><strong>Comparative Data</strong></td>
                        <td><small class="text-success fw-bold">Not required</small></td>
                        <td><small>Year-over-year comparisons required</small></td>
                    </tr>
                    <tr>
                        <td><strong>Transition Plan</strong></td>
                        <td><small>High-level directional commitments</small></td>
                        <td><small>Concrete plan with milestones</small></td>
                    </tr>
                    <tr>
                        <td><strong>GHG Intensity</strong></td>
                        <td><small>Simplified denominator acceptable</small></td>
                        <td><small>Consistent metrics with trend analysis</small></td>
                    </tr>
                    <tr>
                        <td><strong>Financial Effects</strong></td>
                        <td><small>Qualitative (二段階開示) — Japan specific</small></td>
                        <td><small>Progressively quantify impacts</small></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}
