{% extends "base.html" %}
{% block title %}Combined Report — {{ assessment.title }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4 no-print">
    <div>
        <h2><i class="bi bi-file-earmark-pdf me-2"></i>Combined Report</h2>
        <p class="text-muted mb-0">{{ assessment.title }} | {{ assessment.entity_name }} | {{ assessment.fiscal_year }}</p>
    </div>
    <div>
        <button onclick="window.print()" class="btn btn-danger me-2">
            <i class="bi bi-printer me-1"></i>Print / Save PDF
        </button>
        <a href="{{ url_for('assessment.view', assessment_id=assessment.id) }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-1"></i>Back
        </a>
    </div>
</div>

<!-- Cover / Header (print only shows this at top) -->
<div class="print-only mb-4" style="text-align: center; padding: 2rem 0; border-bottom: 2px solid #333;">
    <h1 style="font-size: 1.8rem;">SSBJ Gap Analysis Report</h1>
    <h3 style="color: #666;">{{ assessment.entity_name }}</h3>
    <p>{{ assessment.title }} | {{ assessment.fiscal_year }}</p>
    <p class="text-muted small">Generated {{ "now" | default("") }}{% set sections_list = [] %}{% if 'exec' in sections %}{% if sections_list.append('Executive Summary') %}{% endif %}{% endif %}{% if 'gap' in sections %}{% if sections_list.append('Gap Analysis') %}{% endif %}{% endif %}{% if 'roadmap' in sections %}{% if sections_list.append('Roadmap') %}{% endif %}{% endif %}{% if 'raci' in sections %}{% if sections_list.append('RACI') %}{% endif %}{% endif %}{% if 'relief' in sections %}{% if sections_list.append('Relief Advisor') %}{% endif %}{% endif %}{% if 'audit' in sections %}{% if sections_list.append('Mock Audit') %}{% endif %}{% endif %}
    | Sections: {{ sections_list | join(', ') }}</p>
</div>

<!-- Table of Contents -->
<div class="card mb-4 no-print">
    <div class="card-header"><i class="bi bi-list-ul me-2"></i>Contents</div>
    <div class="card-body py-2">
        <div class="d-flex flex-wrap gap-2">
            {% if 'exec' in sections %}<a href="#sec-exec" class="btn btn-sm btn-outline-dark">Executive Summary</a>{% endif %}
            {% if 'gap' in sections %}<a href="#sec-gap" class="btn btn-sm btn-outline-primary">Gap Analysis</a>{% endif %}
            {% if 'roadmap' in sections %}<a href="#sec-roadmap" class="btn btn-sm btn-outline-warning">Roadmap</a>{% endif %}
            {% if 'raci' in sections %}<a href="#sec-raci" class="btn btn-sm btn-outline-secondary">RACI Matrix</a>{% endif %}
            {% if 'relief' in sections %}<a href="#sec-relief" class="btn btn-sm btn-outline-success">Relief Advisor</a>{% endif %}
            {% if 'audit' in sections %}<a href="#sec-audit" class="btn btn-sm btn-outline-danger">Mock Audit</a>{% endif %}
        </div>
    </div>
</div>

{# ==================== EXECUTIVE SUMMARY ==================== #}
{% if 'exec' in sections and exec_summary %}
<div class="page-break-before" id="sec-exec">
    <h3 class="mb-3"><i class="bi bi-briefcase me-2"></i>Executive Summary — Board/Management</h3>

    <!-- Verdict Banner -->
    <div class="card mb-3" style="border: 2px solid {% if exec_summary.verdict == 'on_track' %}#22c55e{% elif exec_summary.verdict == 'minor_gaps' %}#eab308{% elif exec_summary.verdict == 'action_needed' %}#f97316{% else %}#ef4444{% endif %};">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-3 text-center">
                    <div style="font-size: 2.5rem; font-weight: bold; color: {% if exec_summary.verdict == 'on_track' %}#22c55e{% elif exec_summary.verdict == 'minor_gaps' %}#eab308{% elif exec_summary.verdict == 'action_needed' %}#f97316{% else %}#ef4444{% endif %};">
                        {{ exec_summary.overall_score }}
                    </div>
                    <div class="text-muted small">Overall Score (out of 5.0)</div>
                </div>
                <div class="col-md-9">
                    <h4 style="color: {% if exec_summary.verdict == 'on_track' %}#22c55e{% elif exec_summary.verdict == 'minor_gaps' %}#eab308{% elif exec_summary.verdict == 'action_needed' %}#f97316{% else %}#ef4444{% endif %};">
                        {{ exec_summary.verdict_label }}
                    </h4>
                    <p class="mb-0">{{ exec_summary.verdict_detail }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Key Numbers -->
    <div class="row mb-3">
        <div class="col-md-2">
            <div class="card"><div class="card-body text-center py-2">
                <div class="fw-bold" style="font-size: 1.3rem;">{{ exec_summary.total_gaps }}</div>
                <small class="text-muted">Total Gaps</small>
            </div></div>
        </div>
        <div class="col-md-2">
            <div class="card" style="border-color: rgba(239,68,68,0.5);"><div class="card-body text-center py-2">
                <div class="fw-bold text-danger" style="font-size: 1.3rem;">{{ exec_summary.la_gaps_count }}</div>
                <small class="text-muted">LA-Critical</small>
            </div></div>
        </div>
        <div class="col-md-2">
            <div class="card"><div class="card-body text-center py-2">
                <div class="fw-bold" style="font-size: 1.3rem;">{{ exec_summary.total_scored }}/{{ exec_summary.total_criteria }}</div>
                <small class="text-muted">Assessed</small>
            </div></div>
        </div>
        <div class="col-md-2">
            <div class="card"><div class="card-body text-center py-2">
                {% if exec_summary.months_remaining is not none %}
                <div class="fw-bold" style="font-size: 1.3rem;">{{ exec_summary.months_remaining }}mo</div>
                <small class="text-muted">To Disclosure</small>
                <br><span class="badge bg-{% if exec_summary.urgency == 'critical' %}danger{% elif exec_summary.urgency == 'tight' %}warning text-dark{% elif exec_summary.urgency == 'adequate' %}info{% else %}success{% endif %}">{{ exec_summary.urgency|upper }}</span>
                {% else %}
                <div class="fw-bold" style="font-size: 1.3rem;">—</div>
                <small class="text-muted">Timeline TBD</small>
                {% endif %}
            </div></div>
        </div>
        <div class="col-md-2">
            <div class="card"><div class="card-body text-center py-2">
                {% if exec_summary.months_to_assurance is not none %}
                <div class="fw-bold" style="font-size: 1.3rem;">{{ exec_summary.months_to_assurance }}mo</div>
                <small class="text-muted">To Assurance</small>
                <br><span class="badge bg-{% if exec_summary.assurance_urgency == 'critical' %}danger{% elif exec_summary.assurance_urgency == 'tight' %}warning text-dark{% elif exec_summary.assurance_urgency == 'adequate' %}info{% else %}success{% endif %}">{{ exec_summary.assurance_urgency|upper }}</span>
                {% endif %}
            </div></div>
        </div>
    </div>

    <!-- Pillar Scores -->
    <div class="row mb-3">
        {% for pillar, score in exec_summary.pillar_scores.items() %}
        <div class="col-md-3">
            <div class="card"><div class="card-body text-center py-2">
                <div class="fw-bold {% if score < 2 %}text-danger{% elif score < 3 %}text-warning{% else %}text-success{% endif %}" style="font-size: 1.2rem;">{{ score }}</div>
                <small>{{ pillar }}</small>
                {% if score < 3 %}<br><span class="badge bg-danger" style="font-size: 0.6em;">Below Threshold</span>{% endif %}
            </div></div>
        </div>
        {% endfor %}
    </div>

    <!-- SSBJ Standard Breakdown -->
    {% if exec_summary.standard_breakdown %}
    <div class="card mb-3">
        <div class="card-header"><i class="bi bi-layers me-2"></i><strong>SSBJ Standard Breakdown</strong></div>
        <div class="card-body py-2">
            <div class="row text-center">
                <div class="col-md-6">
                    <small class="fw-bold">SSBJ No.1 — General (IFRS S1)</small>
                    <div class="small">{{ exec_summary.standard_breakdown.s1_total }} criteria | <span class="{% if exec_summary.standard_breakdown.s1_gaps %}text-danger{% else %}text-success{% endif %}">{{ exec_summary.standard_breakdown.s1_gaps }} gaps</span></div>
                    <small class="text-muted">Governance, strategy, risk management fundamentals</small>
                </div>
                <div class="col-md-6">
                    <small class="fw-bold">SSBJ No.2 — Climate (IFRS S2)</small>
                    <div class="small">{{ exec_summary.standard_breakdown.s2_total }} criteria | <span class="{% if exec_summary.standard_breakdown.s2_gaps %}text-danger{% else %}text-success{% endif %}">{{ exec_summary.standard_breakdown.s2_gaps }} gaps</span></div>
                    <small class="text-muted">GHG emissions, climate scenarios, transition plans</small>
                </div>
            </div>
            <p class="small text-muted text-center mt-2 mb-0"><i class="bi bi-info-circle me-1"></i>Year 1 transition relief allows climate-focused (SSBJ No.2) disclosure first. See Relief Advisor for details.</p>
        </div>
    </div>
    {% endif %}

    <!-- Minimum Requirements -->
    {% if exec_summary.minimum_requirements %}
    <div class="card mb-3">
        <div class="card-header" style="background: var(--gradient-red);"><span class="text-white fw-bold"><i class="bi bi-exclamation-octagon me-2"></i>Minimum Requirements — What Must Be Done</span></div>
        <div class="card-body p-0">
            {% for req in exec_summary.minimum_requirements %}
            <div class="p-3 {% if not loop.last %}border-bottom{% endif %}">
                <div class="d-flex align-items-start">
                    <i class="bi {{ req.icon }} me-2 mt-1" style="font-size: 1.2rem; color: var(--accent-blue);"></i>
                    <div class="flex-grow-1">
                        <strong>{{ req.area }}</strong>
                        <p class="mb-1">{{ req.what }}</p>
                        <small class="text-muted"><i class="bi bi-info-circle me-1"></i>{{ req.why }}</small>
                        <br><small class="text-danger">Gaps: {{ req.gaps | join(', ') }}</small>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% else %}
    <div class="alert alert-success mb-3"><i class="bi bi-check-circle me-2"></i>All criteria meet minimum threshold. Focus on maintaining quality and preparing evidence for assurance.</div>
    {% endif %}

    <!-- Investment Options -->
    <h5 class="mt-4 mb-3"><i class="bi bi-cash-stack me-2"></i>Investment Options</h5>
    <div class="row mb-3">
        <!-- Option A -->
        <div class="col-md-6">
            <div class="card h-100" style="border-top: 3px solid var(--accent-blue);">
                <div class="card-header">
                    <strong>Option A: {{ exec_summary.option_a.name }}</strong>
                    <br><small class="text-muted">{{ exec_summary.option_a.subtitle }}</small>
                </div>
                <div class="card-body">
                    <h6 class="small fw-bold mb-2">Approach</h6>
                    <ul class="ps-3 mb-3" style="font-size: 0.85em;">
                        {% for item in exec_summary.option_a.approach %}
                        <li>{{ item }}</li>
                        {% endfor %}
                    </ul>

                    <h6 class="small fw-bold mb-2">Estimated Investment</h6>
                    <table class="table table-sm mb-2" style="font-size: 0.8em;">
                        {% for item in exec_summary.option_a.investment_items %}
                        <tr><td>{{ item.item }}</td><td class="text-end text-nowrap"><strong>{{ item.range }}</strong></td></tr>
                        {% endfor %}
                    </table>
                    <div class="text-center p-2 rounded" style="background: rgba(59,130,246,0.1);">
                        <strong style="font-size: 1.1em;">{{ exec_summary.option_a.total_range }}</strong>
                    </div>

                    <h6 class="small fw-bold mt-3 mb-1 text-success">Advantages</h6>
                    <ul class="ps-3 mb-2" style="font-size: 0.8em;">
                        {% for p in exec_summary.option_a.pros %}<li>{{ p }}</li>{% endfor %}
                    </ul>
                    <h6 class="small fw-bold mb-1 text-danger">Limitations</h6>
                    <ul class="ps-3 mb-2" style="font-size: 0.8em;">
                        {% for c in exec_summary.option_a.cons %}<li>{{ c }}</li>{% endfor %}
                    </ul>
                    <small class="text-muted"><i class="bi bi-lightbulb me-1"></i>{{ exec_summary.option_a.best_for }}</small>
                </div>
            </div>
        </div>
        <!-- Option B -->
        <div class="col-md-6">
            <div class="card h-100" style="border-top: 3px solid var(--accent-green);">
                <div class="card-header">
                    <strong>Option B: {{ exec_summary.option_b.name }}</strong>
                    <br><small class="text-muted">{{ exec_summary.option_b.subtitle }}</small>
                </div>
                <div class="card-body">
                    <h6 class="small fw-bold mb-2">Approach</h6>
                    <ul class="ps-3 mb-3" style="font-size: 0.85em;">
                        {% for item in exec_summary.option_b.approach %}
                        <li>{{ item }}</li>
                        {% endfor %}
                    </ul>

                    <h6 class="small fw-bold mb-2">Estimated Investment</h6>
                    <table class="table table-sm mb-2" style="font-size: 0.8em;">
                        {% for item in exec_summary.option_b.investment_items %}
                        <tr><td>{{ item.item }}</td><td class="text-end text-nowrap"><strong>{{ item.range }}</strong></td></tr>
                        {% endfor %}
                    </table>
                    <div class="text-center p-2 rounded" style="background: rgba(34,197,94,0.1);">
                        <strong style="font-size: 1.1em;">{{ exec_summary.option_b.total_range }}</strong>
                    </div>

                    <h6 class="small fw-bold mt-3 mb-1 text-success">Advantages</h6>
                    <ul class="ps-3 mb-2" style="font-size: 0.8em;">
                        {% for p in exec_summary.option_b.pros %}<li>{{ p }}</li>{% endfor %}
                    </ul>
                    <h6 class="small fw-bold mb-1 text-danger">Limitations</h6>
                    <ul class="ps-3 mb-2" style="font-size: 0.8em;">
                        {% for c in exec_summary.option_b.cons %}<li>{{ c }}</li>{% endfor %}
                    </ul>
                    <small class="text-muted"><i class="bi bi-lightbulb me-1"></i>{{ exec_summary.option_b.best_for }}</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Key Risks -->
    <div class="card mb-3">
        <div class="card-header"><i class="bi bi-exclamation-triangle me-2 text-warning"></i><strong>Key Risks of Delayed Action</strong></div>
        <div class="card-body p-0">
            <table class="table table-sm mb-0">
                <thead><tr><th>Risk</th><th>Potential Impact</th><th>Likelihood</th></tr></thead>
                <tbody>
                    {% for r in exec_summary.risks %}
                    <tr>
                        <td><strong>{{ r.risk }}</strong></td>
                        <td><small>{{ r.impact }}</small></td>
                        <td><span class="badge bg-{% if r.likelihood == 'High' %}danger{% elif r.likelihood == 'Medium' %}warning text-dark{% else %}success{% endif %}">{{ r.likelihood }}</span></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Key Decisions -->
    {% if exec_summary.key_decisions %}
    <div class="card mb-3">
        <div class="card-header" style="background: var(--gradient-blue);"><span class="text-white fw-bold"><i class="bi bi-lightning-charge me-2"></i>Key Decisions Required</span></div>
        <div class="card-body p-0">
            <table class="table table-sm mb-0">
                <thead><tr><th>#</th><th>Decision</th><th>Deadline</th><th>Owner</th></tr></thead>
                <tbody>
                    {% for d in exec_summary.key_decisions %}
                    <tr>
                        <td>{{ loop.index }}</td>
                        <td>{{ d.decision }}</td>
                        <td><span class="badge bg-{% if 'Immediate' in d.deadline or 'week' in d.deadline %}danger{% else %}info{% endif %}">{{ d.deadline }}</span></td>
                        <td><small>{{ d.owner }}</small></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <div class="card mb-3">
        <div class="card-body py-2 text-center">
            <small class="text-muted">
                <i class="bi bi-info-circle me-1"></i>
                Investment estimates are indicative ranges based on typical Japanese listed company costs.
                Actual costs depend on organizational complexity, number of sites, existing systems, and provider selection.
                All estimates exclude internal staff time unless specifically noted.
            </small>
        </div>
    </div>
</div>
{% endif %}

{# ==================== GAP ANALYSIS ==================== #}
{% if 'gap' in sections %}
<div class="page-break-before" id="sec-gap">
    <h3 class="mb-3"><i class="bi bi-file-earmark-text me-2"></i>Gap Analysis Report</h3>

    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card stat-card stat-blue">
                <div class="card-body text-center">
                    <div class="stat-value" style="color: var(--accent-blue); font-size: 1.5rem;">{{ assessment.overall_score }}</div>
                    <div class="stat-label">Overall Score</div>
                    <small style="color: var(--text-muted);">out of 5.0</small>
                </div>
            </div>
        </div>
        {% for pillar, score in pillar_scores.items() %}
        <div class="col-md-{{ 9 // (pillar_scores|length) if pillar_scores|length else 3 }}">
            <div class="card {% if score < 2 %}gap-high{% elif score < 3 %}gap-medium{% else %}gap-low{% endif %}">
                <div class="card-body text-center">
                    <div class="stat-value" style="font-size: 1.3rem;">{{ score }}</div>
                    <div class="stat-label">{{ pillar }}</div>
                    {% if score < 3 %}<span class="badge bg-danger">Below Threshold</span>{% else %}<span class="badge bg-success">Ready</span>{% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- LA-Critical Gaps -->
    {% set la_gaps = [] %}
    {% for gap in gaps %}{% if gap.criterion.la_scope == 'in_scope' %}{% if la_gaps.append(gap) %}{% endif %}{% endif %}{% endfor %}
    {% if la_gaps %}
    <div class="card mb-3" style="border: 1px solid rgba(239,68,68,0.4);">
        <div class="card-header" style="background: var(--gradient-red);">
            <span class="text-white fw-bold"><i class="bi bi-shield-exclamation me-2"></i>LA Critical Gaps ({{ la_gaps|length }})</span>
        </div>
        <div class="card-body p-0">
            <table class="table table-sm mb-0">
                <thead><tr><th>ID</th><th>Category</th><th>Score</th><th>Minimum Action</th></tr></thead>
                <tbody>
                    {% for gap in la_gaps %}
                    <tr>
                        <td><code>{{ gap.criterion.id }}</code></td>
                        <td><small>{{ gap.criterion.category }}</small></td>
                        <td><span class="score-badge score-{{ gap.response.score }}">{{ gap.response.score }}</span></td>
                        <td><small>{{ gap.criterion.minimum_action }}</small></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <!-- Other Gaps -->
    {% set other_gaps = [] %}
    {% for gap in gaps %}{% if gap.criterion.la_scope != 'in_scope' %}{% if other_gaps.append(gap) %}{% endif %}{% endif %}{% endfor %}
    {% if other_gaps %}
    <div class="card mb-3">
        <div class="card-header"><i class="bi bi-exclamation-triangle me-2 text-warning"></i>Other Gaps ({{ other_gaps|length }})</div>
        <div class="card-body p-0">
            <table class="table table-sm mb-0">
                <thead><tr><th>ID</th><th>Category</th><th>Score</th><th>Minimum Action</th></tr></thead>
                <tbody>
                    {% for gap in other_gaps %}
                    <tr>
                        <td><code>{{ gap.criterion.id }}</code></td>
                        <td><small>{{ gap.criterion.category }}</small></td>
                        <td><span class="score-badge score-{{ gap.response.score }}">{{ gap.response.score }}</span></td>
                        <td><small>{{ gap.criterion.minimum_action }}</small></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    {% if not gaps %}
    <div class="alert alert-success"><i class="bi bi-check-circle me-2"></i>All criteria meet the minimum maturity level.</div>
    {% endif %}

    <!-- Detailed Scores -->
    {% for pillar, criteria in criteria_by_pillar.items() %}
    <div class="card mb-3">
        <div class="card-header">{{ pillar }} — Detailed Scores</div>
        <div class="card-body p-0">
            <table class="table table-sm mb-0">
                <thead><tr><th>ID</th><th>Category</th><th>Score</th><th>Evidence</th></tr></thead>
                <tbody>
                    {% for c in criteria %}
                    {% set resp = responses.get(c.id) %}
                    <tr{% if c.la_scope == 'in_scope' %} style="background: rgba(239,68,68,0.08);"{% endif %}>
                        <td><code>{{ c.id }}</code></td>
                        <td>{{ c.category }}</td>
                        <td>{% if resp and resp.score is not none %}<span class="score-badge score-{{ resp.score }}">{{ resp.score }}</span>{% else %}<span class="text-muted">—</span>{% endif %}</td>
                        <td><small>{{ (resp.evidence[:80] + '...') if resp and resp.evidence and resp.evidence|length > 80 else (resp.evidence if resp and resp.evidence else '—') }}</small></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}

{# ==================== ROADMAP ==================== #}
{% if 'roadmap' in sections and roadmap %}
<div class="page-break-before" id="sec-roadmap">
    <h3 class="mb-3"><i class="bi bi-calendar3 me-2"></i>Compliance Roadmap</h3>

    <!-- Overview Cards -->
    <div class="row mb-3">
        <div class="col-md-3">
            <div class="card">
                <div class="card-body text-center">
                    <div class="stat-value" style="font-size: 1.2rem;">{{ roadmap.months_remaining }} months</div>
                    <div class="stat-label">To Compliance</div>
                    <small class="text-muted">by March {{ roadmap.compliance_year }}</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body text-center">
                    <div class="stat-value" style="font-size: 1.2rem;">{{ roadmap.months_to_assurance }} months</div>
                    <div class="stat-label">To 1st Assurance</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body text-center">
                    <div class="stat-value" style="font-size: 1.2rem;">{{ roadmap.gaps.total_gaps }}</div>
                    <div class="stat-label">Gaps to Close</div>
                    <small class="text-danger">{{ roadmap.gaps.la_critical|length }} in LA scope</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body text-center">
                    <div class="stat-value" style="font-size: 1.2rem;">{{ roadmap.phases | length }}</div>
                    <div class="stat-label">Phases</div>
                    <small class="badge bg-{% if roadmap.urgency == 'critical' %}danger{% elif roadmap.urgency == 'tight' %}warning text-dark{% elif roadmap.urgency == 'adequate' %}info{% else %}success{% endif %}">{{ roadmap.urgency|upper }}</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary -->
    <div class="card mb-3">
        <div class="card-header"><i class="bi bi-lightbulb me-2"></i>Readiness Summary</div>
        <div class="card-body py-2">
            {% for line in roadmap.summary %}
            <p class="mb-1 small {% if 'CRITICAL' in line %}text-danger fw-bold{% endif %}">{{ line }}</p>
            {% endfor %}
        </div>
    </div>

    <!-- Phases -->
    {% for phase in roadmap.phases %}
    <div class="card mb-3">
        <div class="card-header {% if phase.number == 6 %}bg-danger text-white{% elif phase.number == 7 %}bg-dark text-white{% endif %}">
            <strong>Phase {{ phase.number }}: {{ phase.title }}</strong>
            <small class="{% if phase.number in (6, 7) %}text-white-50{% else %}text-muted{% endif %} ms-2">{{ phase.subtitle }}</small>
            <span class="badge bg-{% if phase.number in (6, 7) %}light text-dark{% else %}{{ phase.color }}{% endif %} float-end">{{ phase.duration }}</span>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-4">
                    <h6 class="small fw-bold" style="color: var(--accent-blue);"><i class="bi bi-people me-1"></i>Management & Governance</h6>
                    <ul class="ps-3 mb-0" style="font-size: 0.8em;">
                        {% for task in phase.tasks.management %}
                        <li {% if 'URGENT' in task or 'CRITICAL' in task or 'ACCELERATED' in task %}class="text-danger fw-bold"{% endif %}>{{ task }}</li>
                        {% endfor %}
                    </ul>
                </div>
                <div class="col-md-4">
                    <h6 class="small fw-bold" style="color: var(--accent-green);"><i class="bi bi-gear me-1"></i>Technical & IT</h6>
                    <ul class="ps-3 mb-0" style="font-size: 0.8em;">
                        {% for task in phase.tasks.technical %}
                        <li {% if 'CRITICAL' in task or 'FAST-TRACK' in task %}class="text-danger fw-bold"{% endif %}>{{ task }}</li>
                        {% endfor %}
                        {% if not phase.tasks.technical %}
                        <li class="text-muted">No specific technical tasks this phase</li>
                        {% endif %}
                    </ul>
                </div>
                <div class="col-md-4">
                    <h6 class="small fw-bold" style="color: var(--accent-yellow);"><i class="bi bi-shield-check me-1"></i>Assurance Readiness</h6>
                    <ul class="ps-3 mb-0" style="font-size: 0.8em;">
                        {% for task in phase.tasks.assurance %}
                        <li {% if 'IMMEDIATE' in task or 'FAST-TRACK' in task %}class="text-danger fw-bold"{% endif %}>{{ task }}</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}

{# ==================== RACI MATRIX ==================== #}
{% if 'raci' in sections and raci %}
<div class="page-break-before" id="sec-raci">
    <h3 class="mb-3"><i class="bi bi-diagram-3 me-2"></i>RACI Matrix</h3>

    <div class="card mb-3">
        <div class="card-body py-2">
            <small class="text-muted">
                <span class="badge" style="background:#dc3545;color:white;">R</span> Responsible
                <span class="badge ms-2" style="background:#ffc107;color:#212529;">A</span> Accountable
                <span class="badge ms-2" style="background:#0d6efd;color:white;">C</span> Consulted
                <span class="badge ms-2" style="background:#6c757d;color:white;">I</span> Informed
            </small>
        </div>
    </div>

    <!-- Priority Actions -->
    {% if raci.priority_actions %}
    <div class="card mb-3" style="border: 1px solid rgba(239,68,68,0.4);">
        <div class="card-header" style="background: var(--gradient-red);">
            <span class="text-white fw-bold">Priority Actions: LA Gaps ({{ raci.priority_actions|length }})</span>
        </div>
        <div class="card-body p-0">
            <table class="table table-sm mb-0">
                <thead><tr><th>Criterion</th><th>Score</th><th>Gap</th><th>Responsible</th><th>Accountable</th></tr></thead>
                <tbody>
                    {% for a in raci.priority_actions %}
                    <tr>
                        <td><code>{{ a.criterion_id }}</code> <small class="text-muted">{{ a.category }}</small></td>
                        <td>{% if a.score is not none %}<span class="score-badge score-{{ a.score }}">{{ a.score }}</span>{% else %}—{% endif %}</td>
                        <td><span class="badge bg-danger">+{{ a.gap }}</span></td>
                        <td><small>{{ a.responsible | join(', ') }}</small></td>
                        <td><small>{{ a.accountable | join(', ') }}</small></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <!-- Workload -->
    <div class="card mb-3">
        <div class="card-header">Department Workload</div>
        <div class="card-body p-0">
            <table class="table table-sm mb-0">
                <thead><tr><th>Department</th><th class="text-center">R</th><th class="text-center">A</th><th class="text-center">C</th><th class="text-center">I</th></tr></thead>
                <tbody>
                    {% for code, name in raci.departments %}
                    {% set w = raci.dept_workload[code] %}
                    {% if w.R + w.A + w.C + w.I > 0 %}
                    <tr>
                        <td><strong>{{ name }}</strong></td>
                        <td class="text-center">{{ w.R or '—' }}</td>
                        <td class="text-center">{{ w.A or '—' }}</td>
                        <td class="text-center">{{ w.C or '—' }}</td>
                        <td class="text-center">{{ w.I or '—' }}</td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Full Matrix per Pillar -->
    {% set pillar_order = ['Governance', 'Strategy', 'Risk Management', 'Metrics & Targets'] %}
    {% for pillar in pillar_order %}
    {% set pillar_criteria = raci.criteria | selectattr('pillar', 'equalto', pillar) | list %}
    {% if pillar_criteria %}
    <div class="card mb-3">
        <div class="card-header">{{ pillar }}</div>
        <div class="card-body p-0">
            <table class="table table-sm mb-0" style="font-size: 0.8em;">
                <thead>
                    <tr>
                        <th>ID</th><th>Category</th><th>Score</th>
                        {% for code, name in raci.departments %}
                        <th class="text-center" title="{{ name }}" style="min-width:35px;">{{ name.split('/')[0].split(' ')[0][:4] }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for row in pillar_criteria %}
                    <tr{% if row.la_scope == 'in_scope' %} style="background:rgba(239,68,68,0.08);"{% endif %}>
                        <td><code>{{ row.id }}</code></td>
                        <td><small>{{ row.category }}</small></td>
                        <td>{% if row.score is not none %}<span class="score-badge score-{{ row.score }}">{{ row.score }}</span>{% else %}—{% endif %}</td>
                        {% for code, name in raci.departments %}
                        {% set role = row.dept_roles.get(code, '') %}
                        <td class="text-center">
                            {% if role == 'R' %}<span class="badge" style="background:#dc3545;color:white;font-size:0.7em;">R</span>
                            {% elif role == 'A' %}<span class="badge" style="background:#ffc107;color:#212529;font-size:0.7em;">A</span>
                            {% elif role == 'C' %}<span class="badge" style="background:#0d6efd;color:white;font-size:0.7em;">C</span>
                            {% elif role == 'I' %}<span class="badge" style="background:#6c757d;color:white;font-size:0.7em;">I</span>
                            {% endif %}
                        </td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
    {% endfor %}
</div>
{% endif %}

{# ==================== RELIEF ADVISOR ==================== #}
{% if 'relief' in sections and relief %}
<div class="page-break-before" id="sec-relief">
    <h3 class="mb-3"><i class="bi bi-clock-history me-2"></i>Transitional Relief Advisor</h3>

    <div class="row mb-3">
        <div class="col-md-3">
            <div class="card"><div class="card-body text-center">
                <div class="stat-value" style="font-size: 1.2rem;">{% if relief.summary.is_first_year %}Year 1{% else %}Year 2+{% endif %}</div>
                <div class="stat-label">Reporting Period</div>
                <small class="text-muted">FY ends {{ relief.summary.first_fy_end }}</small>
            </div></div>
        </div>
        <div class="col-md-3">
            <div class="card"><div class="card-body text-center">
                <div class="stat-value" style="font-size: 1.2rem;">{{ relief.summary.months_to_deadline }}</div>
                <div class="stat-label">Months to FY End</div>
            </div></div>
        </div>
        <div class="col-md-3">
            <div class="card"><div class="card-body text-center">
                <div class="stat-value" style="font-size: 1.2rem;">{{ relief.summary.total_relief_available }}</div>
                <div class="stat-label">Reliefs Available</div>
            </div></div>
        </div>
        <div class="col-md-3">
            <div class="card"><div class="card-body text-center">
                <div class="stat-value" style="font-size: 1.2rem;">{{ relief.summary.critical_now }}</div>
                <div class="stat-label">Fix Now (LA Gaps)</div>
            </div></div>
        </div>
    </div>

    <!-- Available Reliefs Table -->
    {% set available = [] %}
    {% for item in relief.relief_items %}{% if item.applicable %}{% if available.append(item) %}{% endif %}{% endif %}{% endfor %}
    {% if available %}
    <div class="card mb-3">
        <div class="card-header" style="background: var(--gradient-green);"><span class="text-white fw-bold">Available Reliefs ({{ available|length }})</span></div>
        <div class="card-body p-0">
            <table class="table table-sm mb-0">
                <thead><tr><th>ID</th><th>Type</th><th>Can Defer/Simplify</th><th>Must Still Do</th><th>Year 2</th></tr></thead>
                <tbody>
                    {% for item in available %}
                    <tr>
                        <td><code>{{ item.criterion_id }}</code></td>
                        <td>{% if item.is_deferral %}<span class="badge bg-success">Defer</span>{% else %}<span class="badge bg-info">Simplify</span>{% endif %}</td>
                        <td><small>{{ item.what_you_can_defer }}</small></td>
                        <td><small>{{ item.what_you_must_do }}</small></td>
                        <td><small class="text-muted">{{ item.year2_requirement }}</small></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <!-- Japan Shortcuts -->
    {% if relief.japan_items %}
    <div class="card mb-3">
        <div class="card-header" style="background: var(--gradient-blue);"><span class="text-white fw-bold">Japan-Specific Shortcuts ({{ relief.japan_items|length }})</span></div>
        <div class="card-body p-0">
            <table class="table table-sm mb-0">
                <thead><tr><th>ID</th><th>Alternative</th><th>Action</th><th>Benefit</th></tr></thead>
                <tbody>
                    {% for item in relief.japan_items %}
                    <tr>
                        <td><code>{{ item.criterion_id }}</code></td>
                        <td><small>{{ item.alternative }}</small></td>
                        <td><small>{{ item.action }}</small></td>
                        <td><small class="text-muted">{{ item.benefit }}</small></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <!-- No Relief Items -->
    {% if relief.no_relief_items %}
    <div class="card mb-3">
        <div class="card-header"><i class="bi bi-x-octagon me-2 text-danger"></i><strong>No Relief — Must Address from Year 1 ({{ relief.no_relief_items|length }})</strong></div>
        <div class="card-body p-0">
            <table class="table table-sm mb-0">
                <thead><tr><th>ID</th><th>Category</th><th>Score</th><th>Status</th><th>Reason</th></tr></thead>
                <tbody>
                    {% for item in relief.no_relief_items %}
                    <tr {% if item.at_risk %}style="background:rgba(239,68,68,0.06);"{% endif %}>
                        <td><code>{{ item.criterion_id }}</code></td>
                        <td><small>{{ item.category }}</small></td>
                        <td>{% if item.score is not none %}<span class="score-badge score-{{ item.score }}">{{ item.score }}</span>{% else %}—{% endif %}</td>
                        <td>{% if item.at_risk %}<span class="badge bg-danger">At Risk</span>{% else %}<span class="badge bg-success">OK</span>{% endif %}</td>
                        <td><small class="text-muted">{{ item.reason }}</small></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <!-- Climate-Only Year 1 -->
    {% if relief.climate_only_option and relief.climate_only_option.available %}
    <div class="card mb-3" style="border-left: 3px solid var(--accent-blue);">
        <div class="card-header"><i class="bi bi-cloud-sun me-2"></i><strong>Climate-Only Year 1 Option</strong></div>
        <div class="card-body py-2">
            <p class="small mb-2">{{ relief.climate_only_option.note }}</p>
            <div class="row">
                <div class="col-md-6">
                    <small class="fw-bold text-success">Deferrable S1 items ({{ relief.climate_only_option.s1_deferrable_count }}):</small>
                    <small>{% for item in relief.climate_only_option.s1_deferrable %}{{ item.id }}{% if not loop.last %}, {% endif %}{% endfor %}</small>
                </div>
                <div class="col-md-6">
                    <small class="fw-bold text-danger">NOT deferrable S1 items ({{ relief.climate_only_option.s1_la_scope_count }}, in LA scope):</small>
                    <small>{% for item in relief.climate_only_option.s1_la_scope %}{{ item.id }}{% if not loop.last %}, {% endif %}{% endfor %}</small>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endif %}

{# ==================== MOCK AUDIT ==================== #}
{% if 'audit' in sections and sim %}
<div class="page-break-before" id="sec-audit">
    <h3 class="mb-3"><i class="bi bi-shield-check me-2"></i>Assurance Readiness — Mock Audit (ISSA 5000)</h3>

    <div class="row mb-3">
        <div class="col-md-4">
            <div class="card"><div class="card-body text-center">
                <div class="stat-value" style="font-size: 1.2rem;">{{ sim.readiness_summary.pass_pct }}%</div>
                <div class="stat-label">Pass Rate</div>
            </div></div>
        </div>
        <div class="col-md-4">
            <div class="card"><div class="card-body text-center">
                <div class="stat-value" style="font-size: 1.2rem;">{{ sim.readiness_summary.at_risk + sim.readiness_summary.not_ready }}</div>
                <div class="stat-label">Will Fail</div>
            </div></div>
        </div>
        <div class="col-md-4">
            <div class="card"><div class="card-body text-center">
                <div class="stat-value" style="font-size: 1.2rem;">{{ sim.readiness_summary.total }}</div>
                <div class="stat-label">In-Scope Items</div>
            </div></div>
        </div>
    </div>

    {% for item in sim.ssbj_items %}
    <div class="card mb-3" style="border-left: 4px solid {% if item.readiness.level == 'ready' %}#22c55e{% elif item.readiness.level == 'borderline' %}#eab308{% else %}#ef4444{% endif %};">
        <div class="card-header">
            <code>{{ item.id }}</code> — <strong>{{ item.category }}</strong>
            <span class="badge bg-{{ item.readiness.badge }} ms-2">{{ item.readiness.label }}</span>
            {% if item.score is not none %}<span class="score-badge score-{{ item.score }} ms-1">{{ item.score }}</span>{% endif %}
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-6">
                    <h6 class="small fw-bold"><i class="bi bi-chat-left-quote me-1 text-primary"></i>Auditor Will Ask</h6>
                    <ol class="ps-3 mb-0">
                        {% for q in item.inquiry %}<li><small>{{ q }}</small></li>{% endfor %}
                    </ol>
                </div>
                <div class="col-md-6">
                    <h6 class="small fw-bold"><i class="bi bi-folder-check me-1 text-success"></i>Documents Needed</h6>
                    <ul class="list-unstyled mb-0">
                        {% for doc in item.documents_needed %}
                        <li><small>{% if doc.mentioned %}<i class="bi bi-check-circle-fill text-success me-1"></i>{% else %}<i class="bi bi-circle text-muted me-1"></i>{% endif %}{{ doc.document }}</small></li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            <div class="mt-2">
                <h6 class="small fw-bold"><i class="bi bi-flag-fill me-1 text-danger"></i>Red Flags</h6>
                <ul class="ps-3 mb-0">
                    {% for flag in item.red_flags %}<li><small class="text-danger">{{ flag }}</small></li>{% endfor %}
                </ul>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}

{% endblock %}

{% block extra_scripts %}
<style>
@media print {
    .no-print { display: none !important; }
    .print-only { display: block !important; }
    .page-break-before { page-break-before: always; }
    .card { break-inside: avoid; }
    body { font-size: 11px; }
}
@media screen {
    .print-only { display: none; }
}
.page-break-before:first-of-type { page-break-before: avoid; }
</style>
{% endblock %}
