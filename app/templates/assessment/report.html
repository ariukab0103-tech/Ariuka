{% extends "base.html" %}
{% block title %}Report: {{ assessment.title }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2><i class="bi bi-file-earmark-text me-2"></i>Gap Analysis Report</h2>
        <p class="text-muted mb-0">{{ assessment.title }} | {{ assessment.entity_name }} | {{ assessment.fiscal_year }}</p>
    </div>
    <div>
        <button onclick="window.print()" class="btn btn-danger me-2">
            <i class="bi bi-file-earmark-pdf me-1"></i>Export PDF
        </button>
        <a href="{{ url_for('assessment.view', assessment_id=assessment.id) }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-1"></i>Back
        </a>
    </div>
</div>

<!-- Summary Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card stat-card">
            <div class="card-body text-center">
                <div class="stat-value">{{ assessment.overall_score }}</div>
                <div class="stat-label">Overall Score</div>
                <small class="text-muted">out of 5.0</small>
            </div>
        </div>
    </div>
    {% for pillar, score in pillar_scores.items() %}
    <div class="col-md-{{ 9 // (pillar_scores|length) if pillar_scores|length else 3 }}">
        <div class="card {% if score < 2 %}gap-high{% elif score < 3 %}gap-medium{% else %}gap-low{% endif %}">
            <div class="card-body text-center">
                <div class="stat-value" style="font-size: 1.5rem;">{{ score }}</div>
                <div class="stat-label">{{ pillar }}</div>
                {% if score < 3 %}
                <span class="badge bg-danger">Below Threshold</span>
                {% else %}
                <span class="badge bg-success">Assurance Ready</span>
                {% endif %}
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<div class="row mb-4">
    <!-- Pillar Chart -->
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header">Pillar Scores vs. Limited Assurance Threshold</div>
            <div class="card-body">
                <canvas id="pillarChart" height="220"></canvas>
            </div>
        </div>
    </div>
    <!-- Category Chart -->
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header">Category Breakdown</div>
            <div class="card-body">
                <canvas id="categoryChart" height="220"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Identified Gaps -->
{% if gaps %}

<!-- LA-Critical Gaps First -->
{% set la_gaps = [] %}
{% for gap in gaps %}
    {% if gap.criterion.la_scope == 'in_scope' %}
        {% if la_gaps.append(gap) %}{% endif %}
    {% endif %}
{% endfor %}
{% if la_gaps %}
<div class="card mb-4 border-danger">
    <div class="card-header bg-danger text-white">
        <i class="bi bi-shield-exclamation me-2"></i>
        PRIORITY 1: Limited Assurance Critical Gaps — Must Fix First
        <span class="badge bg-light text-danger ms-2">{{ la_gaps|length }} items</span>
    </div>
    <div class="card-body">
        <p class="text-danger fw-bold mb-3">These items are directly in scope for limited assurance (Scope 1 & 2 GHG). An auditor WILL examine these. Fix these before anything else.</p>
        {% for gap in la_gaps %}
        <div class="card mb-3 border-danger">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <div>
                        <code class="fs-6">{{ gap.criterion.id }}</code> — <strong>{{ gap.criterion.category }}</strong>
                        <span class="badge bg-danger ms-2">Score: {{ gap.response.score }}/5 (need 3+)</span>
                    </div>
                    <span class="badge bg-danger">{{ 3 - gap.response.score }} levels to close</span>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="bg-light p-3 rounded h-100">
                            <h6 class="text-success mb-2"><i class="bi bi-check-circle me-1"></i>Minimum to Comply (Target: Score 3)</h6>
                            <small>{{ gap.criterion.minimum_action }}</small>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="bg-light p-3 rounded h-100">
                            <h6 class="text-primary mb-2"><i class="bi bi-star me-1"></i>Best Practice (Score 4-5)</h6>
                            <small>{{ gap.criterion.best_practice }}</small>
                        </div>
                    </div>
                </div>
                {% if gap.criterion.internal_controls %}
                <div class="alert alert-warning mt-2 mb-0 py-2">
                    <small><i class="bi bi-gear me-1"></i><strong>Internal Controls Required:</strong> {{ gap.criterion.internal_controls }}</small>
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Other Gaps (supporting + not in scope) -->
{% set other_gaps = [] %}
{% for gap in gaps %}
    {% if gap.criterion.la_scope != 'in_scope' %}
        {% if other_gaps.append(gap) %}{% endif %}
    {% endif %}
{% endfor %}
{% if other_gaps %}
<div class="card mb-4">
    <div class="card-header">
        <i class="bi bi-exclamation-triangle me-2 text-warning"></i>
        PRIORITY 2: Other Gaps Below Threshold
        <span class="badge bg-warning text-dark ms-2">{{ other_gaps|length }} items</span>
    </div>
    <div class="card-body p-0">
        <table class="table table-hover mb-0">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Obligation</th>
                    <th>Priority</th>
                    <th>Score</th>
                    <th>Minimum to Comply</th>
                    <th>Best Practice</th>
                </tr>
            </thead>
            <tbody>
                {% for gap in other_gaps %}
                <tr>
                    <td>
                        <code>{{ gap.criterion.id }}</code>
                        <br><small class="text-muted">{{ gap.criterion.category }}</small>
                    </td>
                    <td>
                        {% set ob = obligation_labels.get(gap.criterion.obligation, {}) %}
                        <span class="badge bg-{{ ob.get('badge', 'secondary') }}" style="font-size: 0.7em;">
                            {{ ob.get('label', gap.criterion.obligation)|replace(' (SHALL)', '')|replace(' (SHOULD)', '') }}
                        </span>
                    </td>
                    <td>
                        {% set lp = la_priority_labels.get(gap.criterion.la_priority, {}) %}
                        <span class="badge bg-{{ lp.get('badge', 'secondary') }}" style="font-size: 0.7em;">
                            {{ lp.get('label', gap.criterion.la_priority) }}
                        </span>
                    </td>
                    <td><span class="score-badge score-{{ gap.response.score }}">{{ gap.response.score }}</span></td>
                    <td><small>{{ gap.criterion.minimum_action }}</small></td>
                    <td><small>{{ gap.criterion.best_practice[:120] }}{% if gap.criterion.best_practice|length > 120 %}...{% endif %}</small></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

{% else %}
<div class="alert alert-success">
    <i class="bi bi-check-circle me-2"></i>
    All criteria meet the minimum "Defined" maturity level. The entity appears ready for limited assurance.
</div>
{% endif %}

<!-- Detailed Scores by Pillar -->
{% for pillar, criteria in criteria_by_pillar.items() %}
<div class="card mb-3">
    <div class="card-header">
        {{ pillar }} — Detailed Scores
    </div>
    <div class="card-body p-0">
        <table class="table table-sm mb-0">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Obligation</th>
                    <th>Category</th>
                    <th>Score</th>
                    <th>Maturity Level</th>
                    <th>Evidence Summary</th>
                </tr>
            </thead>
            <tbody>
                {% for c in criteria %}
                {% set resp = responses.get(c.id) %}
                <tr{% if c.la_scope == 'in_scope' %} class="table-danger"{% endif %}>
                    <td>
                        <code>{{ c.id }}</code>
                        {% if c.la_scope == 'in_scope' %}
                        <br><span class="badge bg-danger bg-opacity-75" style="font-size: 0.55em;"><i class="bi bi-shield-check"></i></span>
                        {% endif %}
                    </td>
                    <td>
                        {% set ob = obligation_labels.get(c.obligation, {}) %}
                        <span class="badge bg-{{ ob.get('badge', 'secondary') }}" style="font-size: 0.65em;">
                            {{ ob.get('label', c.obligation)|replace(' (SHALL)', '')|replace(' (SHOULD)', '') }}
                        </span>
                    </td>
                    <td>{{ c.category }}</td>
                    <td>
                        {% if resp and resp.score is not none %}
                        <span class="score-badge score-{{ resp.score }}">{{ resp.score }}</span>
                        {% else %}
                        <span class="text-muted">—</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if resp and resp.score is not none %}
                        {{ maturity_levels[resp.score].label }}
                        {% else %}
                        Not assessed
                        {% endif %}
                    </td>
                    <td><small>{{ (resp.evidence[:80] + '...') if resp and resp.evidence and resp.evidence|length > 80 else (resp.evidence if resp and resp.evidence else '—') }}</small></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endfor %}
{% endblock %}

{% block extra_scripts %}
<script>
const pillarScores = {{ pillar_scores | tojson }};
const categoryScores = {{ category_scores | tojson }};

// Pillar bar chart
new Chart(document.getElementById('pillarChart'), {
    type: 'bar',
    data: {
        labels: Object.keys(pillarScores),
        datasets: [{
            label: 'Current Score',
            data: Object.values(pillarScores),
            backgroundColor: Object.values(pillarScores).map(v => v < 2 ? '#fc8181' : v < 3 ? '#f6ad55' : '#68d391'),
            borderRadius: 6
        }, {
            label: 'Limited Assurance Threshold (3.0)',
            data: Object.keys(pillarScores).map(() => 3),
            type: 'line',
            borderColor: '#e53e3e',
            borderDash: [5, 5],
            pointRadius: 0,
            fill: false
        }]
    },
    options: {
        responsive: true,
        scales: { y: { beginAtZero: true, max: 5, ticks: { stepSize: 1 } } },
        plugins: { legend: { position: 'bottom' } }
    }
});

// Category horizontal bar chart
const catLabels = Object.keys(categoryScores);
const catValues = Object.values(categoryScores);
new Chart(document.getElementById('categoryChart'), {
    type: 'bar',
    data: {
        labels: catLabels,
        datasets: [{
            label: 'Score',
            data: catValues,
            backgroundColor: catValues.map(v => v < 2 ? '#fc8181' : v < 3 ? '#f6ad55' : '#68d391'),
            borderRadius: 4
        }]
    },
    options: {
        indexAxis: 'y',
        responsive: true,
        scales: { x: { beginAtZero: true, max: 5, ticks: { stepSize: 1 } } },
        plugins: { legend: { display: false } }
    }
});
</script>
{% endblock %}
