{% extends "base.html" %}
{% block title %}Assessments - SSBJ Gap Analysis{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-clipboard-check me-2"></i>Assessments</h2>
    <a href="{{ url_for('assessment.create') }}" class="btn btn-primary">
        <i class="bi bi-plus-lg me-1"></i>New Assessment
    </a>
</div>

{% if assessments %}
<!-- Search / Filter bar -->
<div class="card mb-3">
    <div class="card-body py-2">
        <div class="row g-2 align-items-center">
            <div class="col-md-5">
                <div class="input-group input-group-sm">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input type="text" class="form-control" id="searchInput" placeholder="Search assessments..." oninput="filterTable()">
                </div>
            </div>
            <div class="col-md-3">
                <select class="form-select form-select-sm" id="statusFilter" onchange="filterTable()">
                    <option value="">All statuses</option>
                    <option value="draft">Draft</option>
                    <option value="in_progress">In Progress</option>
                    <option value="completed">Completed</option>
                    <option value="under_review">Under Review</option>
                    <option value="reviewed">Reviewed</option>
                </select>
            </div>
            <div class="col-md-4 text-end">
                <small style="color: var(--text-muted);" id="resultCount">{{ assessments|length }} assessment(s)</small>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-body p-0">
        <div class="table-responsive">
        <table class="table table-hover mb-0" id="assessmentTable">
            <thead>
                <tr>
                    <th>Title</th>
                    <th>Entity</th>
                    <th>Fiscal Year</th>
                    <th>Status</th>
                    <th>Completion</th>
                    <th>Score</th>
                    <th>Updated</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for a in assessments %}
                <tr data-status="{{ a.status }}" data-search="{{ a.title|lower }} {{ a.entity_name|lower }} {{ a.fiscal_year|lower }}">
                    <td>
                        <a href="{{ url_for('assessment.view', assessment_id=a.id) }}" class="text-decoration-none fw-bold" style="color: var(--accent-cyan);">
                            {{ a.title }}
                        </a>
                    </td>
                    <td>{{ a.entity_name }}</td>
                    <td><small>{{ a.fiscal_year }}</small></td>
                    <td>
                        {% if a.status == 'draft' %}
                        <span class="status-badge bg-secondary text-white">Draft</span>
                        {% elif a.status == 'in_progress' %}
                        <span class="status-badge" style="background: rgba(234,179,8,0.2); color: var(--accent-yellow);">In Progress</span>
                        {% elif a.status == 'completed' %}
                        <span class="status-badge" style="background: rgba(34,197,94,0.2); color: var(--accent-green);">Completed</span>
                        {% elif a.status == 'under_review' %}
                        <span class="status-badge" style="background: rgba(6,182,212,0.2); color: var(--accent-cyan);">Under Review</span>
                        {% elif a.status == 'reviewed' %}
                        <span class="status-badge" style="background: rgba(59,130,246,0.2); color: var(--accent-blue);">Reviewed</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="d-flex align-items-center gap-2">
                            <div class="progress flex-grow-1" style="width: 80px;">
                                <div class="progress-bar {% if a.completion_pct == 100 %}bg-success{% elif a.completion_pct > 50 %}bg-info{% else %}bg-warning{% endif %}" style="width: {{ a.completion_pct }}%"></div>
                            </div>
                            <small>{{ a.completion_pct }}%</small>
                        </div>
                    </td>
                    <td>
                        <span class="score-badge score-{{ (a.overall_score | round | int) if a.overall_score else 0 }}">
                            {{ a.overall_score }}
                        </span>
                    </td>
                    <td><small>{{ a.updated_at.strftime('%Y-%m-%d') if a.updated_at else 'â€”' }}</small></td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <a href="{{ url_for('assessment.view', assessment_id=a.id) }}" class="btn btn-outline-primary" title="View">
                                <i class="bi bi-eye"></i>
                            </a>
                            {% if a.status in ('completed', 'under_review', 'reviewed') %}
                            <a href="{{ url_for('assessment.report', assessment_id=a.id) }}" class="btn btn-outline-success" title="Report">
                                <i class="bi bi-file-earmark-text"></i>
                            </a>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        </div>
    </div>
</div>
{% else %}
<div class="card">
    <div class="card-body text-center py-5" style="color: var(--text-muted);">
        <i class="bi bi-clipboard-check" style="font-size: 3rem;"></i>
        <p class="mt-2">No assessments found. Create your first SSBJ gap analysis.</p>
        <a href="{{ url_for('assessment.create') }}" class="btn btn-primary">
            <i class="bi bi-plus-lg me-1"></i>New Assessment
        </a>
    </div>
</div>
{% endif %}

<!-- Shared with me -->
{% if shared_assessments %}
<h4 class="mt-4 mb-3"><i class="bi bi-people me-2"></i>Shared with Me</h4>
<div class="card">
    <div class="card-body p-0">
        <div class="table-responsive">
        <table class="table table-hover mb-0">
            <thead>
                <tr>
                    <th>Title</th>
                    <th>Entity</th>
                    <th>Owner</th>
                    <th>My Access</th>
                    <th>Status</th>
                    <th>Completion</th>
                    <th>Score</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for a in shared_assessments %}
                <tr>
                    <td>
                        <a href="{{ url_for('assessment.view', assessment_id=a.id) }}" class="text-decoration-none fw-bold" style="color: var(--accent-cyan);">
                            {{ a.title }}
                        </a>
                    </td>
                    <td>{{ a.entity_name }}</td>
                    <td><small>{{ a.author.full_name }}</small></td>
                    <td>
                        {% set my_perm = a.user_permission(current_user) %}
                        {% if my_perm == 'manage' %}
                        <span class="badge" style="background: rgba(59,130,246,0.2); color: var(--accent-blue);">Manage</span>
                        {% elif my_perm == 'edit' %}
                        <span class="badge" style="background: rgba(34,197,94,0.2); color: var(--accent-green);">Edit</span>
                        {% else %}
                        <span class="badge bg-secondary">View</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if a.status == 'draft' %}
                        <span class="status-badge bg-secondary text-white">Draft</span>
                        {% elif a.status == 'in_progress' %}
                        <span class="status-badge" style="background: rgba(234,179,8,0.2); color: var(--accent-yellow);">In Progress</span>
                        {% elif a.status == 'completed' %}
                        <span class="status-badge" style="background: rgba(34,197,94,0.2); color: var(--accent-green);">Completed</span>
                        {% elif a.status == 'under_review' %}
                        <span class="status-badge" style="background: rgba(6,182,212,0.2); color: var(--accent-cyan);">Under Review</span>
                        {% elif a.status == 'reviewed' %}
                        <span class="status-badge" style="background: rgba(59,130,246,0.2); color: var(--accent-blue);">Reviewed</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="d-flex align-items-center gap-2">
                            <div class="progress flex-grow-1" style="width: 80px;">
                                <div class="progress-bar {% if a.completion_pct == 100 %}bg-success{% elif a.completion_pct > 50 %}bg-info{% else %}bg-warning{% endif %}" style="width: {{ a.completion_pct }}%"></div>
                            </div>
                            <small>{{ a.completion_pct }}%</small>
                        </div>
                    </td>
                    <td>
                        <span class="score-badge score-{{ (a.overall_score | round | int) if a.overall_score else 0 }}">
                            {{ a.overall_score }}
                        </span>
                    </td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <a href="{{ url_for('assessment.view', assessment_id=a.id) }}" class="btn btn-outline-primary" title="View">
                                <i class="bi bi-eye"></i>
                            </a>
                            {% if a.status in ('completed', 'under_review', 'reviewed') %}
                            <a href="{{ url_for('assessment.report', assessment_id=a.id) }}" class="btn btn-outline-success" title="Report">
                                <i class="bi bi-file-earmark-text"></i>
                            </a>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_scripts %}
<script>
function filterTable() {
    const search = document.getElementById('searchInput').value.toLowerCase();
    const status = document.getElementById('statusFilter').value;
    const rows = document.querySelectorAll('#assessmentTable tbody tr');
    let visible = 0;

    rows.forEach(function(row) {
        const matchSearch = !search || row.dataset.search.includes(search);
        const matchStatus = !status || row.dataset.status === status;
        const show = matchSearch && matchStatus;
        row.style.display = show ? '' : 'none';
        if (show) visible++;
    });

    document.getElementById('resultCount').textContent = visible + ' assessment(s)';
}

// Focus search on Ctrl+F
document.addEventListener('keydown', function(e) {
    if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
        const input = document.getElementById('searchInput');
        if (input) {
            e.preventDefault();
            input.focus();
            input.select();
        }
    }
});
</script>
{% endblock %}
