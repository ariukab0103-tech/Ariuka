{% extends "base.html" %}
{% block title %}Dashboard - SSBJ Gap Analysis{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0"><i class="bi bi-speedometer2 me-2"></i>Dashboard</h2>
    <a href="{{ url_for('assessment.create') }}" class="btn btn-primary">
        <i class="bi bi-plus-lg me-1"></i>New Assessment
    </a>
</div>

<!-- Stats Row -->
<div class="row mb-4 g-3">
    <div class="col-md-3">
        <div class="card stat-card stat-blue">
            <div class="card-body">
                <i class="bi bi-clipboard-check stat-icon"></i>
                <div class="stat-value" style="color: var(--accent-blue);">{{ stats.total_assessments }}</div>
                <div class="stat-label">Total Assessments</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card stat-yellow">
            <div class="card-body">
                <i class="bi bi-hourglass-split stat-icon"></i>
                <div class="stat-value" style="color: var(--accent-yellow);">{{ stats.in_progress }}</div>
                <div class="stat-label">In Progress</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card stat-green">
            <div class="card-body">
                <i class="bi bi-check-circle stat-icon"></i>
                <div class="stat-value" style="color: var(--accent-green);">{{ stats.completed }}</div>
                <div class="stat-label">Completed</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card stat-purple">
            <div class="card-body">
                <i class="bi bi-search stat-icon"></i>
                <div class="stat-value" style="color: var(--accent-purple);">{{ stats.reviewed }}</div>
                <div class="stat-label">Reviewed</div>
            </div>
        </div>
    </div>
</div>

<!-- Per-Assessment Scores -->
{% if assessment_details %}
<div class="card mb-4">
    <div class="card-header">
        <i class="bi bi-bar-chart me-2"></i>Pillar Scores by Assessment
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
        <table class="table table-hover mb-0">
            <thead>
                <tr>
                    <th>Assessment</th>
                    <th>Entity</th>
                    <th>FY</th>
                    <th>Status</th>
                    <th class="text-center">Overall</th>
                    {% for pillar in all_pillars %}
                    <th class="text-center">{{ pillar }}</th>
                    {% endfor %}
                    <th></th>
                </tr>
            </thead>
            <tbody>
                {% for a in assessment_details %}
                <tr>
                    <td><strong>{{ a.title }}</strong></td>
                    <td><small>{{ a.entity_name }}</small></td>
                    <td><small>{{ a.fiscal_year }}</small></td>
                    <td>
                        {% if a.status == 'draft' %}
                        <span class="status-badge bg-secondary text-white">Draft</span>
                        {% elif a.status == 'in_progress' %}
                        <span class="status-badge" style="background: rgba(234,179,8,0.2); color: var(--accent-yellow);">In Progress</span>
                        {% elif a.status == 'completed' %}
                        <span class="status-badge" style="background: rgba(34,197,94,0.2); color: var(--accent-green);">Completed</span>
                        {% elif a.status == 'under_review' %}
                        <span class="status-badge" style="background: rgba(6,182,212,0.2); color: var(--accent-cyan);">Under Review</span>
                        {% elif a.status == 'reviewed' %}
                        <span class="status-badge" style="background: rgba(59,130,246,0.2); color: var(--accent-blue);">Reviewed</span>
                        {% endif %}
                    </td>
                    <td class="text-center">
                        <span class="score-badge score-{{ (a.overall_score | round | int) }}">
                            {{ a.overall_score }}
                        </span>
                    </td>
                    {% for pillar in all_pillars %}
                    {% set ps = a.pillar_scores.get(pillar, 0) %}
                    <td class="text-center">
                        {% if ps %}
                        <span class="score-badge score-{{ (ps | round | int) }}">{{ ps }}</span>
                        {% else %}
                        <span class="text-muted">—</span>
                        {% endif %}
                    </td>
                    {% endfor %}
                    <td>
                        <a href="{{ url_for('assessment.view', assessment_id=a.id) }}" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-eye"></i>
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        </div>
    </div>
</div>

<div class="row mb-4">
    <!-- Per-assessment bar chart comparison -->
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header">
                <i class="bi bi-bar-chart me-2"></i>Pillar Scores Comparison
            </div>
            <div class="card-body">
                <canvas id="comparisonChart" height="280"></canvas>
            </div>
        </div>
    </div>
    <!-- Radar chart for each assessment -->
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-bullseye me-2"></i>Maturity vs. Target</span>
                {% if assessment_details | length > 1 %}
                <select id="radarSelect" class="form-select form-select-sm" style="width: auto;">
                    {% for a in assessment_details %}
                    <option value="{{ loop.index0 }}">{{ a.title }} ({{ a.fiscal_year }})</option>
                    {% endfor %}
                </select>
                {% endif %}
            </div>
            <div class="card-body">
                <canvas id="radarChart" height="280"></canvas>
            </div>
        </div>
    </div>
</div>
{% else %}
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header"><i class="bi bi-bar-chart me-2"></i>Pillar Scores</div>
            <div class="card-body text-center py-5" style="color: var(--text-muted);">
                <i class="bi bi-bar-chart" style="font-size: 3rem;"></i>
                <p class="mt-2">No scored assessments yet. Upload documents and run auto-assess to see results.</p>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header"><i class="bi bi-bullseye me-2"></i>Maturity Target</div>
            <div class="card-body text-center py-5" style="color: var(--text-muted);">
                <i class="bi bi-bullseye" style="font-size: 3rem;"></i>
                <p class="mt-2">Complete an assessment to see the maturity radar.</p>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Recent Assessments -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-clock-history me-2"></i>All Assessments</span>
        <a href="{{ url_for('assessment.create') }}" class="btn btn-sm btn-primary">
            <i class="bi bi-plus-lg me-1"></i>New Assessment
        </a>
    </div>
    <div class="card-body p-0">
        {% if assessments %}
        <div class="table-responsive">
        <table class="table table-hover mb-0">
            <thead>
                <tr>
                    <th>Title</th>
                    <th>Entity</th>
                    <th>Fiscal Year</th>
                    <th>Status</th>
                    <th>Completion</th>
                    <th>Score</th>
                    <th>Updated</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                {% for a in assessments[:10] %}
                <tr>
                    <td>
                        <a href="{{ url_for('assessment.view', assessment_id=a.id) }}" class="text-decoration-none fw-bold" style="color: var(--accent-cyan);">
                            {{ a.title }}
                        </a>
                    </td>
                    <td>{{ a.entity_name }}</td>
                    <td>{{ a.fiscal_year }}</td>
                    <td>
                        {% if a.status == 'draft' %}
                        <span class="status-badge bg-secondary text-white">Draft</span>
                        {% elif a.status == 'in_progress' %}
                        <span class="status-badge" style="background: rgba(234,179,8,0.2); color: var(--accent-yellow);">In Progress</span>
                        {% elif a.status == 'completed' %}
                        <span class="status-badge" style="background: rgba(34,197,94,0.2); color: var(--accent-green);">Completed</span>
                        {% elif a.status == 'under_review' %}
                        <span class="status-badge" style="background: rgba(6,182,212,0.2); color: var(--accent-cyan);">Under Review</span>
                        {% elif a.status == 'reviewed' %}
                        <span class="status-badge" style="background: rgba(59,130,246,0.2); color: var(--accent-blue);">Reviewed</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="d-flex align-items-center gap-2">
                            <div class="progress" style="width: 80px;">
                                <div class="progress-bar {% if a.completion_pct == 100 %}bg-success{% elif a.completion_pct > 50 %}bg-info{% else %}bg-warning{% endif %}" style="width: {{ a.completion_pct }}%"></div>
                            </div>
                            <small>{{ a.completion_pct }}%</small>
                        </div>
                    </td>
                    <td>
                        <span class="score-badge score-{{ (a.overall_score | round | int) if a.overall_score else 0 }}">
                            {{ a.overall_score }}
                        </span>
                    </td>
                    <td><small>{{ a.updated_at.strftime('%Y-%m-%d') if a.updated_at else '—' }}</small></td>
                    <td>
                        <a href="{{ url_for('assessment.view', assessment_id=a.id) }}" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-eye"></i>
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        </div>
        {% else %}
        <div class="text-center py-5" style="color: var(--text-muted);">
            <i class="bi bi-clipboard-check" style="font-size: 3rem;"></i>
            <p class="mt-2">No assessments yet. Create your first SSBJ gap assessment.</p>
            <a href="{{ url_for('assessment.create') }}" class="btn btn-primary">
                <i class="bi bi-plus-lg me-1"></i>New Assessment
            </a>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
{% if assessment_details %}
<script>
const assessmentDetails = {{ assessment_details | tojson }};
const allPillars = {{ all_pillars | tojson }};
const chartColors = [
    '#3b82f6', '#22c55e', '#eab308', '#ef4444', '#a855f7',
    '#f97316', '#06b6d4', '#ec4899', '#6366f1', '#14b8a6'
];

// ---- Grouped Bar Chart: each assessment's pillar scores side by side ----
const datasets = assessmentDetails.map((a, i) => ({
    label: a.title + ' (' + a.fiscal_year + ')',
    data: allPillars.map(p => a.pillar_scores[p] || 0),
    backgroundColor: chartColors[i % chartColors.length] + 'cc',
    borderColor: chartColors[i % chartColors.length],
    borderWidth: 1,
    borderRadius: 6
}));

// Add target line
datasets.push({
    label: 'Target (3.0)',
    data: allPillars.map(() => 3),
    type: 'line',
    borderColor: '#ef4444',
    borderDash: [5, 5],
    pointRadius: 0,
    fill: false,
    order: 0
});

new Chart(document.getElementById('comparisonChart'), {
    type: 'bar',
    data: { labels: allPillars, datasets: datasets },
    options: {
        responsive: true,
        scales: {
            y: { beginAtZero: true, max: 5, ticks: { stepSize: 1 }, grid: { color: 'rgba(42, 54, 80, 0.5)' } },
            x: { grid: { color: 'rgba(42, 54, 80, 0.3)' } }
        },
        plugins: {
            legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 11 } } }
        }
    }
});

// ---- Radar Chart: switchable per assessment ----
let radarChart;

function renderRadar(idx) {
    const a = assessmentDetails[idx];
    const data = allPillars.map(p => a.pillar_scores[p] || 0);

    if (radarChart) radarChart.destroy();
    radarChart = new Chart(document.getElementById('radarChart'), {
        type: 'radar',
        data: {
            labels: allPillars,
            datasets: [{
                label: a.title + ' (' + a.fiscal_year + ')',
                data: data,
                borderColor: chartColors[idx % chartColors.length],
                backgroundColor: chartColors[idx % chartColors.length] + '33',
                pointBackgroundColor: chartColors[idx % chartColors.length]
            }, {
                label: 'Target (Limited Assurance Ready)',
                data: allPillars.map(() => 3),
                borderColor: '#ef4444',
                backgroundColor: 'rgba(239, 68, 68, 0.08)',
                borderDash: [5, 5],
                pointBackgroundColor: '#ef4444'
            }]
        },
        options: {
            responsive: true,
            scales: {
                r: {
                    beginAtZero: true, max: 5, ticks: { stepSize: 1, backdropColor: 'transparent' },
                    grid: { color: 'rgba(42, 54, 80, 0.5)' },
                    angleLines: { color: 'rgba(42, 54, 80, 0.5)' },
                    pointLabels: { color: '#94a3b8' }
                }
            },
            plugins: {
                legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 11 } } }
            }
        }
    });
}

// Initial render
renderRadar(0);

// Dropdown switcher
const radarSelect = document.getElementById('radarSelect');
if (radarSelect) {
    radarSelect.addEventListener('change', function() {
        renderRadar(parseInt(this.value));
    });
}
</script>
{% endif %}
{% endblock %}
